<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Peperiksaan MRSM Sultan Azlan Shah</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase App (versi 8.x) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<!-- Firebase Realtime Database (versi 8.x) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh; /* Kekalkan ini jika sudah ada */
            display: flex; /* Kekalkan ini jika sudah ada */
            flex-direction: column; /* Kekalkan ini jika sudah ada */
            padding-bottom: 100px; /* Tambah padding bawah untuk ruang tambahan */
        }
        .tab-content {
        flex: 1 0 auto;
        padding-bottom: 40px; /* Ruang tambahan dalam tab */
        }

        .header, .footer {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;

        }

        .footer p {
            font-size: 12px; /* Mengecilkan tulisan */
            font-style: italic; /* Menjadikan italic */
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        /* CSS untuk Pilihan 3 */
        .nav-tabs {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 0;
        }

        .login-section {
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
}
#adminLoginPrompt form {
    text-align: center; /* Memusatkan kandungan borang */
}

#adminLoginPrompt .btn {
    display: block; /* Jadikan butang sebagai blok */
    margin: 0 auto; /* Memusatkan butang secara mendatar */
}
        
#adminPasswordPrompt {
    width: fit-content;
    padding: 0 10px; /* Tambah padding sisi untuk keselesaan */
    max-width: 100%;
    margin: 0 auto;
}

.btn:hover {
            transform: scale(1.05);
            transition: transform 0.3s ease;
        }

        .button-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        }
        /* Penyesuaian untuk smartphone */
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            .login-section {
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <body>
        <body>
            <div class="header">
                <h3>SISTEM KEHADIRAN PEPERIKSAAN MRSM SULTAN AZLAN SHAH</h3>
            </div>
        
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main" type="button" role="tab">Utama</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">Analisis</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">Admin</button>
                </li>
            </ul>
            
            <div class="tab-content" id="myTabContent">
                <!-- Kandungan tab Utama, Analisis, dan Admin yang telah digabungkan -->

    
    <div class="tab-content" id="myTabContent">
        <!-- Tab Utama -->
        <div class="tab-pane fade show active" id="main" role="tabpanel" aria-labelledby="main-tab">
            <div class="container mt-4 fade-in">
                <h2>Rekod Kehadiran</h2>
                <form id="attendanceForm">
                    <div class="mb-3">
                        <label>Peperiksaan:</label>
                        <select class="form-control" id="examType" required>
                            <option value="">Pilih Peperiksaan</option>
                            <option value="UJIAN SETARA I SEM I">UJIAN SETARA I SEM I</option>
                            <option value="UJIAN SETARA II SEM I">UJIAN SETARA II SEM I</option>
                            <option value="PEPERIKSAAN AKHIR SEMESTER I">PEPERIKSAAN AKHIR SEMESTER I</option>
                            <option value="UJIAN SETARA I SEM II">UJIAN SETARA I SEM II</option>
                            <option value="UJIAN SETARA II SEM II">UJIAN SETARA II SEM II</option>
                            <option value="PEPERIKSAAN AKHIR SEMESTER II">PEPERIKSAAN AKHIR SEMESTER II</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Tarikh:</label>
                        <input type="date" class="form-control" id="examDate" required>
                    </div>
                    <div class="mb-3">
                        <label>Masa Dari:</label>
                        <input type="time" class="form-control" id="timeFrom" required>
                    </div>
                    <div class="mb-3">
                        <label>Masa Hingga:</label>
                        <input type="time" class="form-control" id="timeTo" required>
                    </div>
                    <div class="mb-3">
                        <label>Jabatan:</label>
                        <select class="form-control" id="departmentSelect" required>
                            <option value="">Pilih Jabatan</option>
                            <option value="Jabatan Sains Sosial">Jabatan Sains Sosial</option>
                            <option value="Jabatan Sains">Jabatan Sains</option>
                            <option value="Jabatan Matematik">Jabatan Matematik</option>
                            <option value="Jabatan Bahasa">Jabatan Bahasa</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Penyelaras:</label>
                        <select class="form-control" id="coordinatorSelect" required>
                            <option value="">Pilih Penyelaras</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Subjek:</label>
                        <select class="form-control" id="subjectSelect" required>
                            <option value="">Pilih Subjek</option>
                            <option value="Bahasa Melayu">Bahasa Melayu</option>
                            <option value="Bahasa Melayu K1">Bahasa Melayu K1</option>
                             <option value="Bahasa Melayu K2">Bahasa Melayu K2</option>
                            <option value="Bahasa Inggeris">Bahasa Inggeris</option>
                             <option value="Bahasa Inggeris K1">Bahasa Inggeris K1</option>
                            <option value="Bahasa Inggeris K2">Bahasa Inggeris K2</option>
                            <option value="Bahasa Arab">Bahasa Arab</option> <!-- Baris baru ditambah -->
                            <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option>
                            <option value="Sejarah">Sejarah</option>
                            <option value="Sejarah K1">Sejarah K1</option>
                            <option value="Sejarah K2">Sejarah K2</option>
                            <option value="Matematik">Matematik</option>
                            <option value="Matematik K1">Matematik K1</option>
                            <option value="Matematik K2">Matematik K2</option>
                            <option value="Matematik Tambahan">Matematik Tambahan</option>
                            <option value="Matematik Tambahan K1">Matematik Tambahan K1</option>
                            <option value="Matematik Tambahan K2">Matematik Tambahan K2</option>
                            <option value="Fizik">Fizik</option>
                            <option value="Fizik K1">Fizik K1</option>
                            <option value="Fizik K2">Fizik K2</option>
                            <option value="Kimia">Kimia</option>
                            <option value="Kimia K1">Kimia K1</option>
                            <option value="Kimia K2">Kimia K2</option>
                            <option value="Biologi">Biologi</option>
                            <option value="Biologi K1">Biologi K1</option>
                            <option value="Biologi K2">Biologi K2</option>
                            <option value="Prinsip Perakaunan">Prinsip Perakaunan</option>
                            <option value="Prinsip Perakaunan K1">Prinsip Perakaunan K1</option>
                            <option value="Prinsip Perakaunan K2">Prinsip Perakaunan K2</option>
                            <option value="Pend Jasmani dan Kesihatan">Pend Jasmani dan Kesihatan</option>
                            <option value="Sains Komputer">Sains Komputer</option>
                            <option value="Seni Reka Pelajaran">Seni Reka Pelajaran</option>
                            <option value="Geografi">Geografi</option>
                            <option value="Pendidikan Islam">Pendidikan Islam</option>
                            <option value="Sains">Sains</option>
                            <option value="Reka Bentuk dan Teknologi">Reka Bentuk dan Teknologi</option>
                            <option value="Pendidikan Moral">Pendidikan Moral</option>
                            <option value="Seni Visual">Seni Visual</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Tingkatan:</label>
                        <select class="form-control" id="formSelect" onchange="displayStudentList(this.value)" required>
                            <option value="">Pilih Tingkatan</option>
                            <option value="Tingkatan 1">Tingkatan 1</option>
                            <option value="Tingkatan 2">Tingkatan 2</option>
                            <option value="Tingkatan 3">Tingkatan 3</option>
                            <option value="Tingkatan 4">Tingkatan 4</option>
                            <option value="Tingkatan 5">Tingkatan 5</option>
                        </select>
                    </div>
                    <div id="studentList" class="mt-4" style="display: none;">
                        <h3>Nama Pelajar (Tanda Jika Pelajar Tidak Hadir)</h3>
                        <div id="studentTables">
                            <h4>Berlian</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="berlianTableBody"></tbody>
                            </table>
                            <h4>Delima</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="delimaTableBody"></tbody>
                            </table>
                            <h4>Intan</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="intanTableBody"></tbody>
                            </table>
                            <h4>Nilam</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="nilamTableBody"></tbody>
                            </table>
                            <h4>Topaz</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="topazTableBody"></tbody>
                            </table>
                            <h4>Zamrud</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>BIL</th>
                                        <th>NAMA</th>
                                        <th>KELAS</th>
                                        <th>TINGKATAN</th>
                                        <th>TIDAK HADIR</th>
                                    </tr>
                                </thead>
                                <tbody id="zamrudTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="button-container">
                    <button type="submit" class="btn btn-primary mt-3">Hantar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Analisis -->
        <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
            <div class="container mt-4 fade-in">
                <h2>Analisis Kehadiran</h2>
                <div class="mb-3">
                    <label>Tarikh:</label>
                    <input type="date" class="form-control" id="analysisDate" onchange="generateAnalysisReport()" required>
                </div>
                <div id="reportOutput" class="mt-4">
                    <div id="tingkatan1Table" style="display: none;">
                        <h3>Tingkatan 1</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SUBJEK</th>
                                    <th>PENYELARAS</th>
                                    <th>KELAS</th>
                                    <th>TARIKH</th>
                                    <th>MASA</th>
                                    <th>NAMA PELAJAR TIDAK HADIR</th>
                                </tr>
                            </thead>
                            <tbody id="tingkatan1TableBody"></tbody>
                        </table>
                    </div>
                    <div id="tingkatan2Table" style="display: none;">
                        <h3>Tingkatan 2</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SUBJEK</th>
                                    <th>PENYELARAS</th>
                                    <th>KELAS</th>
                                    <th>TARIKH</th>
                                    <th>MASA</th>
                                    <th>NAMA PELAJAR TIDAK HADIR</th>
                                </tr>
                            </thead>
                            <tbody id="tingkatan2TableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="tingkatan3Table" style="display: none;">
                        <h3>Tingkatan 3</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SUBJEK</th>
                                    <th>PENYELARAS</th>
                                    <th>KELAS</th>
                                    <th>TARIKH</th>
                                    <th>MASA</th>
                                    <th>NAMA PELAJAR TIDAK HADIR</th>
                                </tr>
                            </thead>
                            <tbody id="tingkatan3TableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="tingkatan4Table" style="display: none;">
                        <h3>Tingkatan 4</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SUBJEK</th>
                                    <th>PENYELARAS</th>
                                    <th>KELAS</th>
                                    <th>TARIKH</th>
                                    <th>MASA</th>
                                    <th>NAMA PELAJAR TIDAK HADIR</th>
                                </tr>
                            </thead>
                            <tbody id="tingkatan4TableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="tingkatan5Table" style="display: none;">
                        <h3>Tingkatan 5</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SUBJEK</th>
                                    <th>PENYELARAS</th>
                                    <th>KELAS</th>
                                    <th>TARIKH</th>
                                    <th>MASA</th>
                                    <th>NAMA PELAJAR TIDAK HADIR</th>
                                </tr>
                            </thead>
                            <tbody id="tingkatan5TableBody"></tbody>
                        </table>
                    </div>
                </div>
                <button onclick="downloadAnalysisPDF()" class="btn btn-success mt-2">Jana PDF</button>
            </div>
        </div>

        <!-- Tab Admin -->
        <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
            <div class="login-section">
                <button id="adminLoginBtn" class="btn btn-primary" onclick="showAdminLogin()">Log Masuk</button>
                <button id="adminLogoutBtn" class="btn btn-danger" onclick="logoutAdmin()" style="display: none;">Log Keluar</button>
            </div>
            <div id="adminLoginPrompt" style="display: none;" class="container mt-3">
                <form id="adminLoginForm" onsubmit="event.preventDefault(); verifyAdminPrompt();">
                    <div class="mb-3">
                        <input type="password" id="adminPasswordPrompt" class="form-control" placeholder="Masukkan kata laluan" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Sahkan</button>
                </form>
            </div>
            <div class="container mt-4 fade-in">
                <h2></h2><!-- Teks dikosongkan -->
                <div id="adminContent" style="display: none;">
                    <!-- Borang Tambah Pelajar -->
                    <h3>Tambah Pelajar</h3>
                    <form id="addStudentForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="studentName" placeholder="Nama Pelajar" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" id="studentForm" required>
                                <option value="">Pilih Tingkatan</option>
                                <option value="Tingkatan 1">Tingkatan 1</option>
                                <option value="Tingkatan 2">Tingkatan 2</option>
                                <option value="Tingkatan 3">Tingkatan 3</option>
                                <option value="Tingkatan 4">Tingkatan 4</option>
                                <option value="Tingkatan 5">Tingkatan 5</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" id="studentClass" required>
                                <option value="">Pilih Kelas</option>
                                <option value="Berlian">Berlian</option>
                                <option value="Delima">Delima</option>
                                <option value="Intan">Intan</option>
                                <option value="Nilam">Nilam</option>
                                <option value="Topaz">Topaz</option>
                                <option value="Zamrud">Zamrud</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Tambah Pelajar</button>
                    </form>
                    <!-- Borang Hapus Pelajar -->
                    <h3 class="mt-4">Hapus Pelajar</h3>
                    <form id="deleteStudentForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="deleteStudentName" placeholder="Nama Pelajar" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" id="deleteStudentFormSelect" required>
                                <option value="">Pilih Tingkatan</option>
                                <option value="Tingkatan 1">Tingkatan 1</option>
                                <option value="Tingkatan 2">Tingkatan 2</option>
                                <option value="Tingkatan 3">Tingkatan 3</option>
                                <option value="Tingkatan 4">Tingkatan 4</option>
                                <option value="Tingkatan 5">Tingkatan 5</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" id="deleteStudentClass" required>
                                <option value="">Pilih Kelas</option>
                                <option value="Berlian">Berlian</option>
                                <option value="Delima">Delima</option>
                                <option value="Intan">Intan</option>
                                <option value="Nilam">Nilam</option>
                                <option value="Topaz">Topaz</option>
                                <option value="Zamrud">Zamrud</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-danger">Hapus Pelajar</button>
                    </form>
                    <!-- Borang Tambah Guru -->
                    <h3 class="mt-4">Tambah Guru</h3>
                    <form id="addTeacherForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="teacherName" placeholder="Nama Guru" required>
                        </div>
                        <button type="submit" class="btn btn-success">Tambah Guru</button>
                    </form>
                    <!-- Borang Hapus Guru -->
                    <h3 class="mt-4">Hapus Guru</h3>
                    <form id="deleteTeacherForm">
                        <div class="mb-3">
                            <select class="form-control" id="deleteTeacherSelect" required>
                                <option value="">Pilih Guru</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-danger">Hapus Guru</button>
                    </form>
                    <!-- Seksyen Muat Naik Excel -->
                    <h3 class="mt-4">Muat Naik Data Pelajar (Excel)</h3>
                    <div class="mb-3">
                        <input type="file" class="form-control" id="excelUpload" accept=".xlsx, .xls">
                        <button onclick="processExcelData()" class="btn btn-primary mt-2">Muat Naik</button>
                    </div>
                    <!-- Butang Hapus Senarai Nama Pelajar -->
                    <h3 class="mt-4">Hapus Senarai Pelajar</h3>
                    <button onclick="clearStudentList()" class="btn btn-danger">Hapus</button>
                    <!-- Tambah Seksyen Sejarah Rekod Kehadiran di Sini -->
            <h3 class="mt-4">Sejarah Rekod Kehadiran</h3>
            <div id="attendanceHistory" class="mt-3">
            <div class="mb-3">
                    <label>Filter Tarikh:</label>
                    <input type="date" class="form-control" id="historyDateFilter" onchange="filterAttendanceHistory()">
                </div>   
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>TARIKH</th>
                            <th>PEPERIKSAAN</th>
                            <th>SUBJEK</th>
                            <th>TINGKATAN</th>
                            <th>KELAS</th>
                            <th>NAMA PELAJAR</th>
                            <th>TINDAKAN</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Disediakan oleh Amin Ramli untuk UPPM MRSM SAS 2025</p>
        </div>
    
        <!-- Gantikan bahagian <script> ini dengan kod yang diperbaiki -->
        <script>
            // Inisialisasi Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyANV3T5j58RQpBlYoxPy2pb28a9PeKi3nY",
                authDomain: "sistem-kehadiran-peperiksaan.firebaseapp.com",
                databaseURL: "https://sistem-kehadiran-peperiksaan-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "sistem-kehadiran-peperiksaan",
                storageBucket: "sistem-kehadiran-peperiksaan.firebasestorage.app",
                messagingSenderId: "207072869562",
                appId: "1:207072869562:web:ebbdaaeec44819503a1683"
            };
    
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
    
            // Gantikan definisi asal
            let students = [];
            let teachers = [];
            let attendanceRecords = [];
    
            // Ambil data dari Firebase semasa halaman dimuat
            document.addEventListener('DOMContentLoaded', function() {
                initializeCoordinatorDropdowns();
                
                // Ambil senarai pelajar dari Firebase
                database.ref('students').once('value', (snapshot) => {
                    const data = snapshot.val();
                    students = data ? Object.values(data) : [];
                    updateStudentList();
                });
    
                // Ambil senarai guru dari Firebase
                database.ref('teachers').once('value', (snapshot) => {
                    const data = snapshot.val();
                    teachers = data ? Object.values(data) : [
                        "CIKGU AHMAD FIRDAUS", "CIKGU AINOR AFIZAH", "CIKGU ALKASHAH", "CIKGU ALWANI", "CIKGU AMIRULHAMZA",
            "CIKGU ASYIKIN", "CIKGU AZMAIZA", "CIKGU AZNIDAH", "CIKGU CHE MOHD ROZULA", "CIKGU FATIHAH",
            "CIKGU FATIMAH MANEESA", "CIKGU HAIRUL", "CIKGU HARYANI", "CIKGU HASLIZA", "CIKGU JUNA",
            "CIKGU KU SYAZWANI", "CIKGU MASLINA", "CIKGU MUNIRAH", "CIKGU MURNI", "CIKGU MURSYID",
            "CIKGU NORIZAN", "CIKGU NORUL HUDA", "CIKGU NUR AFNI", "CIKGU NUR AZYYATI", "CIKGU NURATIQAH",
            "CIKGU NURHAZWAN", "CIKGU NURUL AIN", "CIKGU NURUL AISHA", "CIKGU NURUL HANANI", "CIKGU NURUL SHAHIRA",
            "CIKGU NURZALIFAH", "CIKGU PUTERI", "CIKGU RAJA NORMA", "CIKGU ROHAIDA", "CIKGU SAIFUL",
            "CIKGU SALMI", "CIKGU SALWANI", "CIKGU SUHAILA", "CIKGU SURAIYA", "CIKGU SYAWAL",
            "CIKGU UMMI ILIANI", "CIKGU UMMI MARIANA", "CIKGU WAN AMIR", "CIKGU WAN SYARIZAL", "CIKGU YAZRE",
            "CIKGU ZULKHAIREE", "CIKGU ZURAIDAH", "UST MOHAMAD AMIN", "UST YUZRAN", "USTZH FAZILA",
            "USTZH NOR FAEZAH", "USTZH SAHARAH", "UST SYAMIL"
                    ];
                    initializeCoordinatorDropdowns();
                });
    
                // Ambil rekod kehadiran dari Firebase
                database.ref('attendanceRecords').once('value', (snapshot) => {
                    const data = snapshot.val();
                    attendanceRecords = data ? Object.values(data) : [];
                });
            });
    
            const { jsPDF } = window.jspdf;
            let isAdminLoggedIn = false;
    
            // Inisialisasi dropdown penyelaras dan hapus guru
            function initializeCoordinatorDropdowns() {
                const coordinatorDropdown = document.getElementById('coordinatorSelect');
                const deleteTeacherDropdown = document.getElementById('deleteTeacherSelect');
                coordinatorDropdown.innerHTML = '<option value="">Pilih Penyelaras</option>';
                deleteTeacherDropdown.innerHTML = '<option value="">Pilih Guru</option>';
    
                teachers.forEach(teacher => {
                    const option1 = document.createElement('option');
                    option1.value = teacher;
                    option1.text = teacher;
                    coordinatorDropdown.add(option1);
    
                    const option2 = document.createElement('option');
                    option2.value = teacher;
                    option2.text = teacher;
                    deleteTeacherDropdown.add(option2);
                });
            }
    
            // Pengesahan admin dari prompt
            function showAdminLogin() {
                document.getElementById('adminLoginPrompt').style.display = 'block';
            }
    
            function verifyAdminPrompt() {
                const password = document.getElementById('adminPasswordPrompt').value;
                if (password === 'admin123') {
                    isAdminLoggedIn = true;
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('adminLoginPrompt').style.display = 'none';
                    document.getElementById('adminLoginBtn').style.display = 'none';
                    document.getElementById('adminLogoutBtn').style.display = 'inline-block';
                    document.getElementById('adminPasswordPrompt').value = '';
                    updateAttendanceHistory(); // Paparkan semua rekod apabila log masuk
                } else {
                    alert('Kata laluan salah!');
                }
            }
    
            function logoutAdmin() {
                isAdminLoggedIn = false;
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('adminLoginBtn').style.display = 'inline-block';
                document.getElementById('adminLogoutBtn').style.display = 'none';
            }
    
            // Fungsi untuk memaparkan dan mengemas kini sejarah rekod
function updateAttendanceHistory(filterDate = null) {
    const historyTableBody = document.getElementById('historyTableBody');
    historyTableBody.innerHTML = '';

    // Ambil data terkini dari Firebase setiap kali fungsi dipanggil
    database.ref('attendanceRecords').once('value', (snapshot) => {
        const data = snapshot.val();
        attendanceRecords = data ? Object.values(data) : [];

        let filteredRecords = attendanceRecords;
        if (filterDate) {
            filteredRecords = attendanceRecords.filter(record => record.date === filterDate);
        }

        if (filteredRecords.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" class="text-center">Tiada rekod untuk tarikh ini</td>';
            historyTableBody.appendChild(row);
        } else {
            // Kumpulkan rekod berdasarkan kombinasi unik
            const groupedRecords = {};
            filteredRecords.forEach(record => {
                const key = `${record.examType}|${record.subject}|${record.form}|${record.class}|${record.date}`;
                if (!groupedRecords[key]) {
                    groupedRecords[key] = {
                        date: record.date,
                        examType: record.examType,
                        subject: record.subject,
                        form: record.form,
                        class: record.class,
                        studentNames: []
                    };
                }
                if (!record.present) {
                    groupedRecords[key].studentNames.push(record.studentName);
                } else if (record.studentName === "Semua Hadir") {
                    groupedRecords[key].studentNames.push("Semua Hadir");
                }
            });

            // Paparkan rekod yang telah digabungkan
            let index = 0;
            Object.values(groupedRecords).forEach(group => {
                const studentList = group.studentNames.length > 0 
                    ? group.studentNames.join(", ") 
                    : "Semua Hadir";
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${group.date}</td>
                    <td>${group.examType}</td>
                    <td>${group.subject}</td>
                    <td>${group.form}</td>
                    <td>${group.class}</td>
                    <td>${studentList}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteAttendanceRecord(${index})">Padam</button></td>
                `;
                historyTableBody.appendChild(row);
                index++;
            });
        }
    });
}
    
            // Fungsi untuk menapis sejarah berdasarkan tarikh
            function filterAttendanceHistory() {
                const filterDate = document.getElementById('historyDateFilter').value;
                updateAttendanceHistory(filterDate);
            }
    
            // Tambah pelajar individu
            document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newStudent = {
                    bil: students.length + 1,
                    nama: document.getElementById('studentName').value,
                    kelas: document.getElementById('studentClass').value,
                    tingkatan: document.getElementById('studentForm').value
                };
                if (students.some(student => student.nama === newStudent.nama)) {
                    alert('Nama pelajar ini sudah wujud!');
                    return;
                }
                students.push(newStudent);
                this.reset();
                alert('Pelajar berjaya ditambah!');
                updateStudentList();
            });
    
            // Hapus pelajar
            document.getElementById('deleteStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const studentName = document.getElementById('deleteStudentName').value;
                const studentForm = document.getElementById('deleteStudentFormSelect').value;
                const studentClass = document.getElementById('deleteStudentClass').value;
                const studentIndex = students.findIndex(student => 
                    student.nama.toLowerCase().trim() === studentName.toLowerCase().trim() && 
                    student.tingkatan === studentForm && 
                    student.kelas === studentClass
                );
                if (studentIndex === -1) {
                    alert('Pelajar tidak ditemui! Pastikan nama, tingkatan, dan kelas betul.');
                    return;
                }
                students.splice(studentIndex, 1);
                this.reset();
                alert('Pelajar berjaya dihapus!');
                updateStudentList();
            });
    
            // Tambah guru
            document.getElementById('addTeacherForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const teacherName = document.getElementById('teacherName').value;
    if (teachers.includes(teacherName)) {
        alert('Nama guru ini sudah wujud!');
        return;
    }
    teachers.push(teacherName);
    this.reset();
    alert('Guru berjaya ditambah!');
    initializeCoordinatorDropdowns();
    saveTeachersToFirebase(); // Simpan ke Firebase
});
    
            // Hapus guru
            document.getElementById('deleteTeacherForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const teacherName = document.getElementById('deleteTeacherSelect').value;
    const teacherIndex = teachers.indexOf(teacherName);
    if (teacherIndex === -1) {
        alert('Guru tidak ditemui!');
        return;
    }
    teachers.splice(teacherIndex, 1);
    this.reset();
    alert('Guru berjaya dihapus!');
    initializeCoordinatorDropdowns();
    saveTeachersToFirebase(); // Simpan ke Firebase
});
    
            // Proses data Excel
            function processExcelData() {
                const fileInput = document.getElementById('excelUpload');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Sila pilih fail Excel terlebih dahulu!');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const validClasses = ['Berlian', 'Delima', 'Intan', 'Nilam', 'Topaz', 'Zamrud'];
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const excelData = XLSX.utils.sheet_to_json(sheet);
                        excelData.forEach(row => {
                            const newStudent = {
                                bil: row['BIL'] || students.length + 1,
                                nama: row['NAMA'],
                                kelas: row['KELAS'],
                                tingkatan: sheetName
                            };
                            if (!validClasses.includes(newStudent.kelas)) {
                                console.warn(`Kelas tidak sah untuk ${newStudent.nama}: ${newStudent.kelas}`);
                                return;
                            }
                            if (!students.some(student => student.nama === newStudent.nama)) {
                                students.push(newStudent);
                            }
                        });
                    });
                    saveStudentsToFirebase();
                    alert('Data pelajar berjaya dimuatnaik!');
                    updateStudentList();
                    fileInput.value = '';
                };
                reader.readAsArrayBuffer(file);
            }
    
            // Hapus senarai pelajar
            function clearStudentList() {
                if (confirm('Adakah anda pasti mahu menghapus semua senarai pelajar?')) {
                    students = [];
                    saveStudentsToFirebase();
                    alert('Semua pelajar telah dihapus!');
                    updateStudentList();
                }
            }
    
            // Kemaskini senarai pelajar di halaman utama
            function updateStudentList() {
                const selectedForm = document.getElementById('formSelect').value;
                if (selectedForm) {
                    displayStudentList(selectedForm);
                } else {
                    const tables = ['berlianTableBody', 'delimaTableBody', 'intanTableBody', 'nilamTableBody', 'topazTableBody', 'zamrudTableBody'];
                    tables.forEach(tableId => {
                        document.getElementById(tableId).innerHTML = '';
                    });
                    document.getElementById('studentList').style.display = 'none';
                }
            }
    
            // Papar senarai pelajar mengikut kelas dan susun A-Z
            function displayStudentList(selectedForm) {
                const classes = ['Berlian', 'Delima', 'Intan', 'Nilam', 'Topaz', 'Zamrud'];
                const tableBodies = {
                    'Berlian': document.getElementById('berlianTableBody'),
                    'Delima': document.getElementById('delimaTableBody'),
                    'Intan': document.getElementById('intanTableBody'),
                    'Nilam': document.getElementById('nilamTableBody'),
                    'Topaz': document.getElementById('topazTableBody'),
                    'Zamrud': document.getElementById('zamrudTableBody')
                };
                classes.forEach(className => {
                    tableBodies[className].innerHTML = '';
                });
                const formStudents = students.filter(student => student.tingkatan === selectedForm);
                if (formStudents.length === 0) {
                    alert('Tiada pelajar didaftarkan untuk tingkatan ini. Sila muat naik data pelajar melalui tab Admin.');
                    document.getElementById('studentList').style.display = 'none';
                    return;
                }
                formStudents.sort((a, b) => a.nama.localeCompare(b.nama));
                classes.forEach(className => {
                    const classStudents = formStudents.filter(student => student.kelas === className);
                    classStudents.forEach((student, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${student.nama}</td>
                            <td>${student.kelas}</td>
                            <td>${student.tingkatan}</td>
                            <td><input type="checkbox" class="attendanceCheckbox" data-student-name="${student.nama}" data-class="${className}"></td>
                        `;
                        tableBodies[className].appendChild(row);
                    });
                    if (classStudents.length > 0) {
                        const allPresentRow = document.createElement('tr');
                        allPresentRow.innerHTML = `
                            <td>-</td>
                            <td colspan="3"><strong>Semua Hadir</strong></td>
                            <td><input type="checkbox" class="allPresentCheckbox" data-class="${className}"></td>
                        `;
                        tableBodies[className].appendChild(allPresentRow);
                    }
                });
                document.getElementById('studentList').style.display = 'block';
                document.querySelectorAll('.allPresentCheckbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const className = this.getAttribute('data-class');
                        const studentCheckboxes = document.querySelectorAll(`.attendanceCheckbox[data-class="${className}"]`);
                        if (this.checked) {
                            studentCheckboxes.forEach(studentCheckbox => {
                                studentCheckbox.checked = false;
                            });
                        }
                    });
                });
                document.querySelectorAll('.attendanceCheckbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const className = this.getAttribute('data-class');
                        const allPresentCheckbox = document.querySelector(`.allPresentCheckbox[data-class="${className}"]`);
                        if (this.checked) {
                            allPresentCheckbox.checked = false;
                        }
                    });
                });
            }
    
            // Simpan pelajar
            function saveStudentsToFirebase() {
                database.ref('students').set(students)
                    .then(() => console.log('Pelajar disimpan ke Firebase'))
                    .catch(error => console.error('Ralat simpan pelajar:', error));
            }
    
            // Simpan guru
            function saveTeachersToFirebase() {
                database.ref('teachers').set(teachers)
                    .then(() => console.log('Guru disimpan ke Firebase'))
                    .catch(error => console.error('Ralat simpan guru:', error));
            }
    
            // Simpan rekod kehadiran
            function saveAttendanceRecordsToFirebase() {
                database.ref('attendanceRecords').set(attendanceRecords)
                    .then(() => console.log('Rekod kehadiran disimpan ke Firebase'))
                    .catch(error => console.error('Ralat simpan rekod kehadiran:', error));
            }
    
            // Padam rekod tertentu
function deleteAttendanceRecord(groupIndex) {
    if (confirm('Adakah anda pasti mahu memadam rekod ini?')) {
        // Ambil data terkini dari Firebase untuk memastikan keselarasan
        database.ref('attendanceRecords').once('value', (snapshot) => {
            const data = snapshot.val();
            attendanceRecords = data ? Object.values(data) : [];

            // Kumpulkan rekod untuk mendapatkan kunci kumpulan
            const groupedRecords = {};
            attendanceRecords.forEach(record => {
                const key = `${record.examType}|${record.subject}|${record.form}|${record.class}|${record.date}`;
                if (!groupedRecords[key]) {
                    groupedRecords[key] = [];
                }
                groupedRecords[key].push(record);
            });

            // Padam semua rekod dalam kumpulan yang dipilih
            const groupKeys = Object.keys(groupedRecords);
            const selectedGroupKey = groupKeys[groupIndex];
            const recordsToDelete = groupedRecords[selectedGroupKey];

            // Buang rekod dari attendanceRecords
            recordsToDelete.forEach(record => {
                const recordIndex = attendanceRecords.findIndex(r => 
                    r.date === record.date && 
                    r.examType === record.examType && 
                    r.subject === record.subject && 
                    r.form === record.form && 
                    r.class === record.class && 
                    r.studentName === record.studentName
                );
                if (recordIndex !== -1) {
                    attendanceRecords.splice(recordIndex, 1);
                }
            });

            saveAttendanceRecordsToFirebase(); // Simpan perubahan ke Firebase
            updateAttendanceHistory(); // Kemas kini paparan sejarah
            alert('Rekod berjaya dipadam!');
        });
    }
}
    
            // Hantar kehadiran ke Firebase
            // Hantar kehadiran ke Firebase
document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const examType = document.getElementById('examType').value;
    const date = document.getElementById('examDate').value;
    const timeFrom = document.getElementById('timeFrom').value;
    const timeTo = document.getElementById('timeTo').value;
    const department = document.getElementById('departmentSelect').value;
    const coordinator = document.getElementById('coordinatorSelect').value;
    const subject = document.getElementById('subjectSelect').value;
    const selectedForm = document.getElementById('formSelect').value;
    const checkboxes = document.querySelectorAll('.attendanceCheckbox');
    const allPresentCheckboxes = document.querySelectorAll('.allPresentCheckbox');

    const allPresentClasses = new Set();
    let hasAbsent = false;
    let hasAllPresent = false;

    // Semak kotak "Semua Hadir"
    allPresentCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const className = checkbox.getAttribute('data-class');
            allPresentClasses.add(className);
            attendanceRecords.push({
                examType,
                date,
                time: `${timeFrom} - ${timeTo}`,
                form: selectedForm,
                class: className,
                department,
                coordinator,
                subject,
                studentName: "Semua Hadir",
                present: true
            });
            hasAllPresent = true;
        }
    });

    // Semak kotak "Tidak Hadir"
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const studentName = checkbox.getAttribute('data-student-name');
            const className = checkbox.getAttribute('data-class');
            const isAbsent = checkbox.checked;

            if (!allPresentClasses.has(className)) {
                const student = students.find(s => s.nama === studentName);
                attendanceRecords.push({
                    examType,
                    date,
                    time: `${timeFrom} - ${timeTo}`,
                    form: selectedForm,
                    class: student.kelas,
                    department,
                    coordinator,
                    subject,
                    studentName,
                    present: !isAbsent
                });
                hasAbsent = true;
            }
        }
    });

    // Jika tiada kotak ditandakan, anggap semua hadir untuk setiap kelas
    if (!hasAbsent && !hasAllPresent) {
        const classes = ['Berlian', 'Delima', 'Intan', 'Nilam', 'Topaz', 'Zamrud'];
        const formStudents = students.filter(student => student.tingkatan === selectedForm);
        
        if (formStudents.length > 0) {
            classes.forEach(className => {
                const classStudents = formStudents.filter(student => student.kelas === className);
                if (classStudents.length > 0) { // Hanya tambah jika kelas mempunyai pelajar
                    attendanceRecords.push({
                        examType,
                        date,
                        time: `${timeFrom} - ${timeTo}`,
                        form: selectedForm,
                        class: className,
                        department,
                        coordinator,
                        subject,
                        studentName: "Semua Hadir",
                        present: true
                    });
                }
            });
        }
    }

    saveAttendanceRecordsToFirebase(); // Simpan ke Firebase
    alert('Kehadiran berjaya dihantar!');
    document.getElementById('studentList').style.display = 'none';
    document.getElementById('attendanceForm').reset();
});
    
            // Jana laporan analisis automatik
            // Jana laporan analisis automatik
function generateAnalysisReport() {
    const date = document.getElementById('analysisDate').value;
    if (!date) return;

    // Ambil data terkini dari Firebase
    database.ref('attendanceRecords').once('value', (snapshot) => {
        const data = snapshot.val();
        attendanceRecords = data ? Object.values(data) : [];

        const forms = ['Tingkatan 1', 'Tingkatan 2', 'Tingkatan 3', 'Tingkatan 4', 'Tingkatan 5'];
        forms.forEach((form, index) => {
            const tableBody = document.getElementById(`tingkatan${index + 1}TableBody`);
            const tableDiv = document.getElementById(`tingkatan${index + 1}Table`);
            tableBody.innerHTML = '';

            // Saring rekod untuk tarikh dan tingkatan tertentu
            const records = attendanceRecords.filter(record => 
                record.date === date && record.form === form
            );

            if (records.length > 0) {
                // Kumpulkan rekod berdasarkan kombinasi unik
                const groupedRecords = {};
                records.forEach(record => {
                    const key = `${record.subject}|${record.coordinator}|${record.class}|${record.date}|${record.time}`;
                    if (!groupedRecords[key]) {
                        groupedRecords[key] = {
                            subject: record.subject,
                            coordinator: record.coordinator,
                            class: record.class,
                            date: record.date,
                            time: record.time,
                            studentNames: []
                        };
                    }
                    // Hanya tambah nama pelajar jika tidak hadir (present: false)
                    if (!record.present) {
                        groupedRecords[key].studentNames.push(record.studentName);
                    } else if (record.studentName === "Semua Hadir") {
                        groupedRecords[key].studentNames.push("Semua Hadir");
                    }
                });

                // Paparkan rekod yang telah digabungkan
                const fragment = document.createDocumentFragment();
                Object.values(groupedRecords).forEach(group => {
                    const studentList = group.studentNames.length > 0 
                        ? group.studentNames.join(", ") 
                        : "Semua Hadir"; // Jika tiada nama pelajar tidak hadir
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${group.subject}</td>
                        <td>${group.coordinator}</td>
                        <td>${group.class}</td>
                        <td>${group.date}</td>
                        <td>${group.time}</td>
                        <td>${studentList}</td>
                    `;
                    fragment.appendChild(row);
                });
                tableBody.appendChild(fragment);
                tableDiv.style.display = 'block';
            } else {
                tableDiv.style.display = 'none';
            }
        });
    });
}
    
            // Jana PDF analisis mengikut reka bentuk jadual web
function downloadAnalysisPDF() {
    const date = document.getElementById('analysisDate').value;
    if (!date) {
        alert('Sila pilih tarikh terlebih dahulu!');
        return;
    }

    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('SENARAI NAMA PELAJAR YANG TIDAK MENDUDUKI PEPERIKSAAN', 105, 20, { align: 'center' });

    const firstRecord = attendanceRecords.find(record => record.date === date);
    const examType = firstRecord ? firstRecord.examType : 'Tidak Ditentukan';

    doc.setFontSize(12);
    doc.text(`Peperiksaan: ${examType}`, 20, 30);
    doc.text(`Tarikh: ${date}`, 20, 40);

    let yPosition = 50;
    const forms = ['Tingkatan 1', 'Tingkatan 2', 'Tingkatan 3', 'Tingkatan 4', 'Tingkatan 5'];
    let hasData = false;

    forms.forEach((form, index) => {
        const records = attendanceRecords.filter(record => 
            record.date === date && record.form === form
        );

        if (records.length > 0) {
            hasData = true;
            doc.setFontSize(14);
            doc.text(form, 20, yPosition);
            yPosition += 10;

            // Kumpulkan rekod berdasarkan kombinasi unik
            const groupedRecords = {};
            records.forEach(record => {
                const key = `${record.subject}|${record.coordinator}|${record.class}|${record.date}|${record.time}`;
                if (!groupedRecords[key]) {
                    groupedRecords[key] = {
                        subject: record.subject,
                        coordinator: record.coordinator,
                        class: record.class,
                        date: record.date,
                        time: record.time,
                        studentNames: []
                    };
                }
                if (!record.present) {
                    groupedRecords[key].studentNames.push(record.studentName);
                } else if (record.studentName === "Semua Hadir") {
                    groupedRecords[key].studentNames.push("Semua Hadir");
                }
            });

            // Format data untuk PDF
            const bodyData = Object.values(groupedRecords).map(group => {
                const studentList = group.studentNames.length > 0 
                    ? group.studentNames.join(", ") 
                    : "Semua Hadir";
                return [
                    group.subject || '',
                    group.coordinator || '',
                    group.class || '',
                    group.date || '',
                    group.time || '',
                    studentList
                ];
            });

            doc.autoTable({
                startY: yPosition,
                head: [['SUBJEK', 'PENYELARAS', 'KELAS', 'TARIKH', 'MASA', 'NAMA PELAJAR TIDAK HADIR']],
                body: bodyData,
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [44, 62, 80] },
                margin: { left: 20, right: 20 }
            });

            yPosition = doc.lastAutoTable.finalY + 10;
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
        }
    });

    if (!hasData) {
        alert('Tiada rekod kehadiran untuk tarikh yang dipilih!');
        return;
    }

    doc.setFontSize(10);
    doc.text('Laporan ini disediakan oleh AJK Tingkatan UPPM MRSM SAS', 105, 280, { align: 'center' });
    doc.save(`Laporan_Kehadiran_${date}.pdf`);
}
    
            // Inisialisasi semasa halaman dimuat
            document.addEventListener('DOMContentLoaded', function() {
                initializeCoordinatorDropdowns();
            });
        </script>
    
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>(function(){ /* ... Cloudflare script ... */ })();</script>
    </body>
    </html>
